<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Thumb Dodge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #0e0f14;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Segoe UI", Roboto, Arial, "Noto Sans JP", sans-serif;
      overflow: hidden;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #ui {
      position: fixed;
      inset: 0;
      padding:
        env(safe-area-inset-top, 0)
        env(safe-area-inset-right, 0)
        env(safe-area-inset-bottom, 0)
        env(safe-area-inset-left, 0);
      pointer-events: none;
    }
    .topbar {
      position: absolute; left: 12px; right: 12px; top: 8px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; opacity: .9;
    }
    .centerMsg {
      position: absolute; inset: 0; display: grid; place-items: center;
      text-align: center; line-height: 1.5; pointer-events: auto;
    }
    .btn {
      display: inline-block; padding: 12px 18px; border-radius: 12px;
      background: rgba(255,255,255,.08); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.15); cursor: pointer;
      font-weight: 700;
    }
    .hint { opacity: .7; font-size: .9rem; margin-top: 8px; }
    .landscapeMask {
      position: fixed; inset: 0; background: #0e0f14; color: #fff;
      display: none; align-items: center; justify-content: center; text-align: center;
      padding: 24px;
    }
    canvas { display: block; width: 100vw; height: 100dvh; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="ui" aria-live="polite">
    <div class="topbar">
      <div id="score">SCORE 0</div>
      <div id="best">BEST 0</div>
    </div>
    <div id="center" class="centerMsg">
      <div>
        <h1 style="margin:0 0 8px 0;">Thumb Dodge</h1>
        <div class="hint">ÁîªÈù¢„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶Â∑¶Âè≥„Å´ÁßªÂãï„ÄÇ<br>Ëµ§„ÅÑ„Éñ„É≠„ÉÉ„ÇØ„Çí„Åï„Åë„Çà„ÅÜÔºÅ</div>
        <div style="height:12px;"></div>
        <div id="startBtn" class="btn" role="button" tabindex="0">„Çø„ÉÉ„Éó„Åó„Å¶ÈñãÂßã</div>
      </div>
    </div>
  </div>
  <div id="landscape" class="landscapeMask">
    <div>Á∏¶Âêë„Åç„Åß„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ üì±</div>
  </div>

  <script>
  (() => {
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
    let dpr = window.devicePixelRatio || 1;

    function resize() {
      dpr = window.devicePixelRatio || 1;
      canvas.width  = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    addEventListener('resize', resize, { passive: true });
    resize();

    const landscapeMask = document.getElementById('landscape');
    function checkOrientation() {
      const isLandscape = window.matchMedia('(orientation: landscape)').matches;
      landscapeMask.style.display = isLandscape ? 'flex' : 'none';
    }
    addEventListener('orientationchange', checkOrientation);
    checkOrientation();

    const center = document.getElementById('center');
    const scoreEl = document.getElementById('score');
    const bestEl  = document.getElementById('best');
    const startBtn = document.getElementById('startBtn');

    let best = Number(localStorage.getItem('thumbdodge_best') || 0);
    bestEl.textContent = `BEST ${best}`;

    let ac, beep;
    function initAudio() {
      if (ac) return;
      try {
        ac = new (window.AudioContext || window.webkitAudioContext)();
        function tone(freq, ms = 80, gain = 0.08) {
          const osc = ac.createOscillator();
          const g = ac.createGain();
          osc.type = 'square';
          osc.frequency.value = freq;
          g.gain.setValueAtTime(gain, ac.currentTime);
          g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + ms/1000);
          osc.connect(g).connect(ac.destination);
          osc.start();
          osc.stop(ac.currentTime + ms/1000);
        }
        beep = {
          ok: () => tone(880, 60, 0.06),
          hit: () => tone(220, 200, 0.12),
        };
      } catch(_) { }
    }

    const W = () => canvas.width / dpr;
    const H = () => canvas.height / dpr;

    const state = {
      running: false, tStart: 0, tPrev: 0, score: 0,
      player: { x: 0, y: 0, w: 60, h: 16, vx: 0 },
      blocks: [], spawn: 0, speed: 120, accel: 2.0, gameover: false,
    };

    function reset() {
      state.running = true; state.tStart = performance.now(); state.tPrev = state.tStart;
      state.score = 0; state.blocks = []; state.speed = 120; state.gameover = false;
      const pw = 60, ph = 16;
      state.player.w = pw; state.player.h = ph;
      state.player.x = (W() - pw)/2; state.player.y = H() - ph - 28; state.player.vx = 0;
      center.style.display = 'none';
    }

    let pointerX = null;
    function setPointerEvents(el) {
      function onDown(e) { initAudio(); const p = e.touches ? e.touches[0] : e; pointerX = p.clientX; }
      function onMove(e) {
        if (pointerX == null) return;
        const p = e.touches ? e.touches[0] : e;
        const dx = p.clientX - pointerX; pointerX = p.clientX;
        state.player.x = Math.max(0, Math.min(W()-state.player.w, state.player.x + dx));
        e.preventDefault();
      }
      function onUp() { pointerX = null; }
      el.addEventListener('pointerdown', onDown);
      el.addEventListener('pointermove', onMove, { passive:false });
      el.addEventListener('pointerup', onUp);
      el.addEventListener('pointercancel', onUp);
      el.addEventListener('touchstart', onDown, { passive:false });
      el.addEventListener('touchmove', onMove, { passive:false });
      el.addEventListener('touchend', onUp);
    }
    setPointerEvents(document.body);

    function rect(a, b) {
      return !(a.x + a.w < b.x || b.x + b.w < a.x || a.y + a.h < b.y || b.y + b.h < a.y);
    }

    function loop(t) {
      requestAnimationFrame(loop);
      if (!state.running) return;
      const dt = Math.min(0.033, (t - state.tPrev) / 1000);
      state.tPrev = t;
      state.speed += state.accel * dt;
      state.score += Math.floor(60 * dt);
      scoreEl.textContent = `SCORE ${state.score}`;
      state.spawn -= dt;
      if (state.spawn <= 0) {
        const w = 30 + Math.random()*70 * (Math.random() < .3 ? 2.2 : 1.0);
        const x = Math.random() * (W() - w);
        const h = 14 + Math.random()*14;
        state.blocks.push({ x, y: -h, w, h, vy: state.speed * (0.9 + Math.random()*0.2) });
        state.spawn = Math.max(0.25, 0.75 - state.speed/600);
      }
      state.blocks.forEach(b => b.y += b.vy * dt);
      state.blocks = state.blocks.filter(b => b.y < H()+40);
      for (const b of state.blocks) {
        if (rect({x: state.player.x, y: state.player.y, w: state.player.w, h: state.player.h}, b)) {
          state.running = false; state.gameover = true;
          best = Math.max(best, state.score); localStorage.setItem('thumbdodge_best', best);
          bestEl.textContent = `BEST ${best}`;
          center.innerHTML = `<div><h2>Game Over</h2><div>Score: <b>${state.score}</b> „Éª Best: <b>${best}</b></div><div style='height:12px;'></div><div id='restart' class='btn'>„ÇÇ„ÅÜ‰∏ÄÂ∫¶</div></div>`;
          document.getElementById('restart').addEventListener('click', () => { beep?.ok(); reset(); });
          center.style.display = 'grid'; beep?.hit(); break;
        }
      }
      ctx.clearRect(0,0,W(),H());
      const grid = 40;
      ctx.globalAlpha = 0.13;
      ctx.beginPath();
      for (let y = ((t/20)%grid); y < H(); y += grid) {
        ctx.moveTo(0, y); ctx.lineTo(W(), y);
      }
      ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 1; ctx.stroke(); ctx.globalAlpha = 1;
      roundRect(ctx, state.player.x, state.player.y, state.player.w, state.player.h, 6);
      ctx.fillStyle = '#7fdfff'; ctx.fill();
      ctx.fillStyle = '#ff4d4d';
      for (const b of state.blocks) { roundRect(ctx, b.x, b.y, b.w, b.h, 4); ctx.fill(); }
    }
    requestAnimationFrame(loop);

    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath(); ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    startBtn.addEventListener('click', () => { beep?.ok(); reset(); });
  })();
  </script>
</body>
</html>